<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Emotion Video Player</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <div id="videoContainer">
    <video id="videoA" autoplay loop muted></video>
    <video id="videoB" autoplay loop muted></video>
  </div>

  <script>
    const deepfaceToKey = {
      happy: "happy",
      angry: "angry",
      fear: "fear",
      fearful: "fear",
      sad: "sad",
      surprise: "surprise",
      surprised: "surprise"
    };

    const emotionToVideos = {
      happy: ["bloemen.mp4", "water.mp4", "wolken.mp4"],
      angry: ["waves.mp4", "vuur.mp4", "lava.mp4"],
      fear: ["kwal.mp4", "storm.mp4", "thunder.mp4"],
      sad: ["mist.mp4", "regen.mp4", "regen 2.mp4"],
      surprise: ["zwart_gat.mp4", "stars.mp4", "kwallen.mp4"]
    };

    const videoA = document.getElementById('videoA');
    const videoB = document.getElementById('videoB');
    let showingA = true;
    let lastEmotion = null;
    let lastFilename = null;
    const socket = io();

    // Init: videoA zichtbaar, videoB onzichtbaar
    videoA.classList.add('show');
    videoB.classList.add('hide');

    socket.on('emotion', function(data) {
      const rawEmotion = data.emotion;
      const emotion = deepfaceToKey[rawEmotion];
      const videoList = emotionToVideos[emotion];
      if (!videoList) return;
      // Kies random video uit de lijst, voorkom herhaling van dezelfde video
      let options = videoList.filter(v => v !== lastFilename);
      if (options.length === 0) options = videoList;
      const filename = options[Math.floor(Math.random() * options.length)];
      if (!filename) return;
      const nextVideo = showingA ? videoB : videoA;
      const prevVideo = showingA ? videoA : videoB;
      nextVideo.src = `/static/videos/${filename}?t=${Date.now()}`;
      nextVideo.load();
      nextVideo.oncanplay = () => {
        // Beide zichtbaar maken voor crossfade
        nextVideo.classList.add('show');
        nextVideo.classList.remove('hide');
        prevVideo.classList.add('show');
        prevVideo.classList.remove('hide');
        // Forceer reflow zodat de transition werkt
        void nextVideo.offsetWidth;
        // Fade in/out
        nextVideo.style.opacity = 1;
        prevVideo.style.opacity = 0;
        nextVideo.play();
        nextVideo.playbackRate = 0.1;
        prevVideo.playbackRate = 0.1;
        // Na de transition de oude video verbergen
        setTimeout(() => {
          prevVideo.classList.remove('show');
          prevVideo.classList.add('hide');
          prevVideo.style.opacity = '';
          nextVideo.style.opacity = '';
        }, 4000); // pas evt. aan als je crossfade tijd wijzigt
        showingA = !showingA;
        lastFilename = filename;
      };
    });
  </script>
</body>
</html>
